<div class="container">
  <div *ngIf="currentStep === 'auth'">
    <div class="header-brand"><h1><span>Health Tracker</span></h1></div>
    <mat-card class="card auth-card">
      <div style="padding: 30px;" [formGroup]="authForm">
        <h2 style="text-align: center; font-weight: 700;">{{ isLoginMode ? '–í—Ö–æ–¥' : '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è' }}</h2>
        <div *ngIf="errorMessage" class="error-banner">{{errorMessage}}</div>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Email</mat-label>
          <input matInput type="email" formControlName="email">
        </mat-form-field>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>–ü–∞—Ä–æ–ª—å</mat-label>
          <input matInput type="password" formControlName="password">
        </mat-form-field>
        <button mat-flat-button color="primary" class="full-width action-btn" (click)="handleAuth()">
          {{ isLoginMode ? '–í–æ–π—Ç–∏' : '–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç' }}
        </button>
        <button mat-button class="full-width" (click)="isLoginMode = !isLoginMode">
          {{ isLoginMode ? '–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è' : '–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏' }}
        </button>
      </div>
    </mat-card>
  </div>

  <div *ngIf="currentStep === 'main' || currentStep === 'setup'">
    <header class="app-header">
      <div class="user-info">
        <span class="welcome">–ü—Ä–∏–≤–µ—Ç,</span>
        <span class="user-name">{{ user?.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' }}</span>
      </div>
      <button mat-icon-button (click)="logout()"><mat-icon>logout</mat-icon></button>
    </header>

    <mat-tab-group [(selectedIndex)]="activeTab" class="custom-tabs">
      <mat-tab label="–û–±–∑–æ—Ä">
        <div class="tab-padding" *ngIf="goal">
          <mat-card class="card date-selector-card">
            <div class="date-picker-container">
              <mat-icon>calendar_today</mat-icon>
              <input type="date" [(ngModel)]="selectedDate" (change)="loadDashboard()" class="date-input">
            </div>
          </mat-card>

          <div class="main-stats-card">
            <div class="kcal-left">
              <span class="label">–û—Å—Ç–∞–ª–æ—Å—å –Ω–∞ {{ selectedDate | date:'dd.MM' }}</span>
              <span class="value">{{ remainingKcal | number:'1.0-0' }}</span>
            </div>
            <div class="stats-line">
              <div class="stat">
                <span class="n">{{ goal.targetIntakeKcal | number:'1.0-0' }}</span>
                <span class="l">–¶–µ–ª—å</span>
              </div>
              <div class="stat">
                <span class="n">{{ goal.currentIntakeKcal | number:'1.0-0' }}</span>
                <span class="l">–ï–¥–∞</span>
              </div>
              <div class="stat">
                <span class="n">{{ goal.currentBurnedKcal | number:'1.0-0' }}</span>
                <span class="l">–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</span>
              </div>
            </div>
          </div>

          <mat-card class="card weight-log-card">
            <div class="weight-header">
              <mat-icon color="primary">monitor_weight</mat-icon>
              <h3>–¢–µ–∫—É—â–∏–π –≤–µ—Å</h3>
              <span class="current-val">{{ goal.currentWeightKg }} –∫–≥</span>
            </div>
            <div class="weight-input-group">
              <input type="number" [(ngModel)]="newWeightLog" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–µ—Å...">
              <button (click)="updateWeight()">–ó–∞–ø–∏—Å–∞—Ç—å</button>
            </div>
          </mat-card>

          <div class="card macro-card">
            <h3>–ú–∞–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç—ã –∑–∞ –¥–µ–Ω—å</h3>
            <div class="macro-item">
              <div class="macro-info">
                <span class="m-name">ü•© –ë–µ–ª–∫–∏</span>
                <span class="m-val">{{ goal.currentProteinGrams | number:'1.0-1' }} / {{ goal.proteinGrams }}–≥</span>
              </div>
              <mat-progress-bar mode="determinate" [value]="proteinPercent" class="p-bar p-protein"></mat-progress-bar>
            </div>
            <div class="macro-item">
              <div class="macro-info">
                <span class="m-name">ü•ë –ñ–∏—Ä—ã</span>
                <span class="m-val">{{ goal.currentFatsGrams | number:'1.0-1' }} / {{ goal.fatsGrams }}–≥</span>
              </div>
              <mat-progress-bar mode="determinate" [value]="fatsPercent" class="p-bar p-fats"></mat-progress-bar>
            </div>
            <div class="macro-item">
              <div class="macro-info">
                <span class="m-name">üçû –£–≥–ª–µ–≤–æ–¥—ã</span>
                <span class="m-val">{{ goal.currentCarbsGrams | number:'1.0-1' }} / {{ goal.carbsGrams }}–≥</span>
              </div>
              <mat-progress-bar mode="determinate" [value]="carbsPercent" class="p-bar p-carbs"></mat-progress-bar>
            </div>
          </div>
        </div>
      </mat-tab>

      <mat-tab label="–ü–∏—Ç–∞–Ω–∏–µ">
        <div class="tab-padding">
          <mat-card class="card date-selector-card">
            <div class="date-picker-container">
              <mat-icon>calendar_today</mat-icon>
              <input type="date" [(ngModel)]="selectedDate" (change)="loadDashboard()" class="date-input">
            </div>
          </mat-card>

          <mat-card class="card">
            <h3>–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</h3>
            <div [formGroup]="foodForm">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞)</mat-label>
                <input matInput formControlName="description">
              </mat-form-field>
              
              <div class="setup-grid">
                <mat-form-field appearance="outline"><mat-label>–ö–∫–∞–ª / 100–≥</mat-label><input matInput type="number" formControlName="caloriesPer100g"></mat-form-field>
                <mat-form-field appearance="outline"><mat-label>–í–µ—Å –ø–æ—Ä—Ü–∏–∏ (–≥)</mat-label><input matInput type="number" formControlName="portionSizeGrams"></mat-form-field>
              </div>

              <div class="macro-inputs-grid">
                <mat-form-field appearance="outline"><mat-label>–ë–µ–ª–∫–∏/100–≥</mat-label><input matInput type="number" formControlName="proteinPer100g"></mat-form-field>
                <mat-form-field appearance="outline"><mat-label>–ñ–∏—Ä—ã/100–≥</mat-label><input matInput type="number" formControlName="fatsPer100g"></mat-form-field>
                <mat-form-field appearance="outline"><mat-label>–£–≥–ª/100–≥</mat-label><input matInput type="number" formControlName="carbsPer100g"></mat-form-field>
              </div>

              <button mat-flat-button color="primary" class="full-width action-btn" (click)="addFood()">–î–æ–±–∞–≤–∏—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏—é</button>
            </div>
          </mat-card>

          <mat-card class="card">
            <h3>–ò—Å—Ç–æ—Ä–∏—è –∑–∞ {{ selectedDate | date:'dd.MM' }}</h3>
            <div *ngIf="dailyFoodLogs.length === 0" class="empty-state">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>
            <div *ngFor="let f of dailyFoodLogs" class="history-item">
              <div class="item-info">
                <span class="item-title">{{ f.description }}</span>
                <span class="item-sub">{{ f.portionSizeGrams }}–≥ ‚Ä¢ –ë:{{f.protein || 0}} –ñ:{{f.fats || 0}} –£:{{f.carbs || 0}}</span>
              </div>
              <div class="item-right">
                <span class="kcal-add">+{{ f.calories | number:'1.0-0' }}</span>
                <button mat-icon-button color="warn" (click)="deleteFoodLog(f.foodId || f.id)">
                  <mat-icon>delete_outline</mat-icon>
                </button>
              </div>
            </div>
          </mat-card>
        </div>
      </mat-tab>

      <mat-tab label="–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏">
        <div class="tab-padding">
          <mat-card class="card date-selector-card">
            <div class="date-picker-container">
              <mat-icon>calendar_today</mat-icon>
              <input type="date" [(ngModel)]="selectedDate" (change)="loadDashboard()" class="date-input">
            </div>
          </mat-card>

          <mat-card class="card">
            <h3>–ó–∞–ø–∏—Å–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h3>
            <div [formGroup]="workoutForm">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>–¢–∏–ø —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</mat-label>
                <input matInput formControlName="type">
              </mat-form-field>
              <div class="setup-grid">
                <mat-form-field appearance="outline"><mat-label>–ú–∏–Ω.</mat-label><input matInput type="number" formControlName="durationMinutes"></mat-form-field>
                <mat-form-field appearance="outline"><mat-label>–ö–∫–∞–ª/–º–∏–Ω</mat-label><input matInput type="number" formControlName="caloriesBurnedPerMinute"></mat-form-field>
              </div>
              <button mat-flat-button color="accent" class="full-width action-btn" (click)="addWorkout()">–ó–∞–ø–∏—Å–∞—Ç—å</button>
            </div>
          </mat-card>

          <mat-card class="card">
            <h3>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å {{ selectedDate | date:'dd.MM' }}</h3>
            <div *ngFor="let w of dailyWorkoutLogs" class="history-item">
              <div><span class="item-title">{{ w.type }}</span>-<span class="item-sub">{{  w.durationMinutes }}  –º–∏–Ω</span></div>
              <div class="item-right">
                <span class="kcal-burn">-{{ w.caloriesBurned | number:'1.0-0' }}</span>
                <button mat-icon-button color="warn" (click)="deleteWorkoutLog(w.workoutId)"><mat-icon>delete_outline</mat-icon></button>
              </div>
            </div>
          </mat-card>
        </div>
      </mat-tab>

      <mat-tab label="–ü—Ä–æ—Ñ–∏–ª—å">
        <div class="tab-padding">
          <mat-card class="card profile-card">
            <div class="profile-avatar-section">
              <div class="avatar-circle"><mat-icon>person</mat-icon></div>
              <h2>{{ user?.name }}</h2>
            </div>

            <div [formGroup]="setupForm" class="profile-grid-form">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>–ò–º—è</mat-label>
                <input matInput formControlName="name">
              </mat-form-field>

              <div class="setup-grid">
                <mat-form-field appearance="outline">
                  <mat-label>–í–æ–∑—Ä–∞—Å—Ç</mat-label>
                  <input matInput type="number" formControlName="age">
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>–ü–æ–ª</mat-label>
                  <mat-select formControlName="gender">
                    <mat-option value="MALE">–ú—É–∂—Å–∫–æ–π</mat-option>
                    <mat-option value="FEMALE">–ñ–µ–Ω—Å–∫–∏–π</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>

              <div class="setup-grid">
                <mat-form-field appearance="outline">
                  <mat-label>–†–æ—Å—Ç (—Å–º)</mat-label>
                  <input matInput type="number" formControlName="heightCm">
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</mat-label>
                  <mat-select formControlName="activityLevel">
                    <mat-option value="SIT">–°–∏–¥—è—á–∞—è (SIT)</mat-option>
                    <mat-option value="LIGHT">–õ–µ–≥–∫–∞—è (LIGHT)</mat-option>
                    <mat-option value="MID">–°—Ä–µ–¥–Ω—è—è (MID)</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>

              <div class="setup-grid">
                <mat-form-field appearance="outline">
                  <mat-label>–ù–∞—á–∞–ª—å–Ω—ã–π –≤–µ—Å (–∫–≥)</mat-label>
                  <input matInput type="number" formControlName="startWeightKg">
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>–¶–µ–ª–µ–≤–æ–π –≤–µ—Å (–∫–≥)</mat-label>
                  <input matInput type="number" formControlName="targetWeightKg">
                </mat-form-field>
              </div>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>–¶–µ–ª—å –≤ –Ω–µ–¥–µ–ª—é (–∫–≥)</mat-label>
                <mat-select formControlName="weeklyGoalKg">
                  <mat-option *ngFor="let g of availableGoals" [value]="g.value">
                    {{ g.label }}
                  </mat-option>
                </mat-select>
              </mat-form-field>

              <button mat-flat-button color="primary" class="full-width action-btn save-btn" (click)="saveProfileData()">
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
              </button>
            </div>
          </mat-card>
        </div>
      </mat-tab>
    </mat-tab-group>
  </div>
</div>